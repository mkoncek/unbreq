#!/usr/bin/env bpftrace

// Generated-by: Claude Code

// Usage: sudo bpftrace trace.bt -- <PID>
// Monitors open/read/exec file activity for PID and its descendants

BEGIN
{
    @target = $1;           // save root PID into a global
    @tracked[@target] = 1;  // mark root PID as tracked
    printf("=== Monitoring PID %d and its descendants (open/read/exec) ===\n", @target);
    printf("Started at %s\n", strftime("%Y-%m-%d %H:%M:%S", nsecs));
    
    // Initialize tracking for standard FDs that might already exist
    @fd_to_path[@target, 0] = "<stdin>";
    @fd_to_path[@target, 1] = "<stdout>";  
    @fd_to_path[@target, 2] = "<stderr>";
    
    // Initialize pending filename storage with empty string to establish type
    @pending_files[0] = "";
}

// When a tracked process forks/clones, track the child too
tracepoint:sched:sched_process_fork
/ @tracked[args->parent_pid] /
{
    @tracked[args->child_pid] = 1;
    printf("[%s] FORK: PID %d -> %d (%s)\n", 
           strftime("%H:%M:%S", nsecs), 
           args->parent_pid, args->child_pid, comm);
           
    // Copy standard FD mappings to child (they're inherited)
    @fd_to_path[args->child_pid, 0] = "<stdin>";
    @fd_to_path[args->child_pid, 1] = "<stdout>";  
    @fd_to_path[args->child_pid, 2] = "<stderr>";
}

// Clean up when processes exit
tracepoint:sched:sched_process_exit
/ @tracked[pid] /
{
    printf("[%s] EXIT: PID %d (%s)\n", 
           strftime("%H:%M:%S", nsecs), pid, comm);
    delete(@tracked[pid]);
    delete(@pending_files[pid]);
    // Note: FD mappings are cleaned up individually when files are closed
}

// Clean up FD mappings when files are closed
tracepoint:syscalls:sys_enter_close
/ @tracked[pid] /
{
    delete(@fd_to_path[pid, args->fd]);
}

// Monitor execve calls (program execution)
tracepoint:syscalls:sys_enter_execve
/ @tracked[pid] /
{
    printf("[%s] EXEC: PID %d (%s) -> %s\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, str(args->filename));
}

// Also catch clone/fork syscalls directly (more comprehensive)
tracepoint:syscalls:sys_enter_clone
/ @tracked[pid] /
{
    printf("[%s] CLONE: PID %d (%s) creating child\n", 
           strftime("%H:%M:%S", nsecs), pid, comm);
}

// Store filename when open is attempted
tracepoint:syscalls:sys_enter_openat
/ @tracked[pid] /
{
    @pending_files[pid] = str(args->filename);
    printf("[%s] OPEN: PID %d (%s) -> %s (flags=%d)\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, 
           str(args->filename), args->flags);
}

// Connect filename to FD when open succeeds
tracepoint:syscalls:sys_exit_openat  
/ @tracked[pid] && args->ret >= 0 /
{
    @fd_to_path[pid, args->ret] = @pending_files[pid];
    printf("[%s] OPEN-SUCCESS: PID %d (%s) fd=%d -> %s\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, args->ret, @pending_files[pid]);
    delete(@pending_files[pid]);
}

// Monitor legacy open syscall
tracepoint:syscalls:sys_enter_open
/ @tracked[pid] /
{
    @pending_files[pid] = str(args->filename);
    printf("[%s] OPEN: PID %d (%s) -> %s (flags=%d)\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, 
           str(args->filename), args->flags);
}

tracepoint:syscalls:sys_exit_open
/ @tracked[pid] && args->ret >= 0 /
{
    @fd_to_path[pid, args->ret] = @pending_files[pid];
    printf("[%s] OPEN-SUCCESS: PID %d (%s) fd=%d -> %s\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, args->ret, @pending_files[pid]);
    delete(@pending_files[pid]);
}

// Monitor file creation
tracepoint:syscalls:sys_enter_creat
/ @tracked[pid] /
{
    @pending_files[pid] = str(args->pathname);
    printf("[%s] CREAT: PID %d (%s) -> %s (mode=%o)\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, 
           str(args->pathname), args->mode);
}

tracepoint:syscalls:sys_exit_creat
/ @tracked[pid] && args->ret >= 0 /
{
    @fd_to_path[pid, args->ret] = @pending_files[pid];
    printf("[%s] CREAT-SUCCESS: PID %d (%s) fd=%d -> %s\n", 
           strftime("%H:%M:%S", nsecs), pid, comm, args->ret, @pending_files[pid]);
    delete(@pending_files[pid]);
}

// Monitor reads
tracepoint:syscalls:sys_enter_read
/ @tracked[pid] /
{
    $path = @fd_to_path[pid, args->fd];
    if ($path != "") {
        printf("[%s] READ: PID %d (%s) fd=%d (%s) count=%d\n", 
               strftime("%H:%M:%S", nsecs), pid, comm, 
               args->fd, $path, args->count);
    } else {
        printf("[%s] READ: PID %d (%s) fd=%d <unknown-file> count=%d\n", 
               strftime("%H:%M:%S", nsecs), pid, comm, 
               args->fd, args->count);
    }
}


END
{
    delete(@pending_files[0]); // Clean up type-establishment entry
    printf("\n=== Monitoring ended at %s ===\n", strftime("%Y-%m-%d %H:%M:%S", nsecs));
}
